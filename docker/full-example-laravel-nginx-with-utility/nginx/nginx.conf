# Server block defines how nginx handles incoming requests
server {
  # Listen on port 80 (standard HTTP port)
  listen 80;
  
  # Define the priority order for index files
  # nginx will look for index.php first, then index.html
  index index.php index.html;

  # Server name - domain name or IP address this server responds to
  server_name localhost;
  
  # Document root points to Laravel's public directory
  # This is where the index.php entry point lives
  root /var/www/html/public;

  # Location block for handling all requests to the root
  location / {
    # try_files directive attempts to serve files in this order:
    # 1. $uri - exact file match (e.g., /image.png)
    # 2. $uri/ - directory match (serves index file from directory)
    # 3. /index.php?$query_string - fallback to Laravel's router
    # This enables Laravel's routing system to handle all dynamic URLs
    try_files $uri $uri/ /index.php?$query_string;
  }

  # Location block for handling PHP files
  # The regex ~ \.php$ matches any URL ending in .php
  location ~ \.php$ {
    # Security: return 404 if the PHP file doesn't exist
    # Prevents malicious requests from being passed to PHP-FPM
    try_files $uri =404;
    
    # Split the URI into script name and path info
    # Example: /index.php/some/path -> script: /index.php, path: /some/path
    fastcgi_split_path_info ^(.+\.php)(/.+)$;
    
    # Pass PHP requests to the PHP-FPM container
    # 'php' is the service name from docker-compose.yml, port 9000 is PHP-FPM
    fastcgi_pass php:9000;
    
    # Default file to look for in a directory
    fastcgi_index index.php;
    
    # Include standard FastCGI parameters (nginx default config)
    include fastcgi_params;
    
    # Tell PHP-FPM the actual file path to execute
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    
    # Pass path info to PHP (needed for some frameworks)
    fastcgi_param PATH_INFO $fastcgi_path_info;
  }
}